openapi: 3.0.3
info:
  title: Pausiva API
  description: |
    API REST del sistema multiagente de acompañamiento Pausiva para mujeres de 40 a 60 años.
    
    ## Características
    - Procesamiento de mensajes con clasificación de riesgo
    - Seguimiento de síntomas y estado emocional
    - Gestión de medicación basada en recetas
    - Gestión de citas médicas
    - Check-in proactivo diario
    
    ## Importante
    Pausiva NO es médico, NO diagnostica, NO prescribe medicación. Solo entrega recomendaciones 
    generales de autocuidado y sugiere consultar profesionales de salud cuando corresponde.
  version: 1.0.0
  contact:
    name: Pausiva Team
  license:
    name: MIT

servers:
  - url: http://localhost:8080
    description: Servidor de desarrollo local

tags:
  - name: Messages
    description: Procesamiento de mensajes de pacientes
  - name: Patients
    description: Gestión de datos de pacientes
  - name: Health
    description: Estado del servicio

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Verifica el estado del servicio
      operationId: healthCheck
      responses:
        '200':
          description: Servicio funcionando correctamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  service:
                    type: string
                    example: pausiva-api

  /message:
    post:
      tags:
        - Messages
      summary: Procesar mensaje
      description: |
        Procesa un mensaje de WhatsApp de una paciente y devuelve una respuesta estructurada.
        
        El sistema automáticamente:
        - Identifica a la paciente por número de teléfono
        - Clasifica el mensaje y lo dirige al agente apropiado
        - Evalúa el nivel de riesgo
        - Guarda el historial de conversación
        - Registra síntomas si los hay
      operationId: processMessage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MessageRequest'
            examples:
              saludo:
                summary: Saludo simple
                value:
                  phone: "+56912345678"
                  message: "Hola, buenos días"
              sintomas:
                summary: Reporte de síntomas
                value:
                  phone: "+56912345678"
                  message: "Me siento cansada y con dolor de cabeza"
              receta:
                summary: Receta médica
                value:
                  phone: "+56912345678"
                  message: "Mi doctora me recetó Metformina 850mg, 1 tableta con el desayuno y 1 con la cena"
              emergencia:
                summary: Emergencia
                value:
                  phone: "+56912345678"
                  message: "Tengo un dolor muy fuerte en el pecho y no puedo respirar bien"
      responses:
        '200':
          description: Mensaje procesado correctamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentResponse'
              examples:
                sintomas_leves:
                  summary: Respuesta a síntomas leves
                  value:
                    reply_text: "Lamento escuchar que te sientes cansada. Es importante que descanses y te mantengas hidratada."
                    actions: ["SEND_MESSAGE", "UPDATE_SYMPTOM_TRACKING"]
                    risk_level: "low"
                    risk_score: 25
                    symptom_summary: "Cansancio y dolor de cabeza leve"
                    medication_schedule: []
                    appointments: []
                    follow_up_questions: ["¿Has podido descansar lo suficiente?"]
                    agent_used: "checkin"
                emergencia:
                  summary: Respuesta a emergencia
                  value:
                    reply_text: "Lo que describes es muy serio. Por favor, busca atención médica de urgencia inmediatamente."
                    actions: ["SEND_MESSAGE", "OPEN_RISK_ALERT"]
                    risk_level: "high"
                    risk_score: 95
                    symptom_summary: "Dolor fuerte en el pecho y dificultad para respirar"
                    medication_schedule: []
                    appointments: []
                    follow_up_questions: []
                    agent_used: "triage"
        '400':
          description: Request inválido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "phone and message are required"
        '500':
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /checkin:
    post:
      tags:
        - Messages
      summary: Generar check-in proactivo
      description: |
        Genera un mensaje de check-in proactivo para enviar a una paciente.
        
        El mensaje varía según la hora del día:
        - Mañana: "Buenos días. ¿Cómo amaneciste hoy?"
        - Tarde: "Buenas tardes. ¿Cómo va tu día?"
        - Noche: "Buenas noches. ¿Cómo te sentiste hoy?"
        
        Útil para cron jobs de seguimiento diario.
      operationId: sendCheckin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckinRequest'
            example:
              phone: "+56912345678"
      responses:
        '200':
          description: Check-in generado correctamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentResponse'
              example:
                reply_text: "Buenos días. ¿Cómo amaneciste hoy? ¿Cómo dormiste anoche?"
                actions: ["SEND_MESSAGE"]
                risk_level: "none"
                risk_score: 0
                symptom_summary: ""
                medication_schedule: []
                appointments: []
                follow_up_questions: []
                agent_used: "checkin"
        '400':
          description: Request inválido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /context/{phone}:
    get:
      tags:
        - Patients
      summary: Obtener contexto de paciente
      description: |
        Obtiene el contexto completo de una paciente incluyendo:
        - Perfil y datos personales
        - Medicación activa
        - Citas próximas
        - Historial de síntomas recientes
        - Resumen de conversación
      operationId: getPatientContext
      parameters:
        - name: phone
          in: path
          required: true
          description: Número de teléfono de la paciente (con o sin +)
          schema:
            type: string
          example: "+56912345678"
      responses:
        '200':
          description: Contexto obtenido correctamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatientContext'
        '500':
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /patient/{phone}:
    delete:
      tags:
        - Patients
      summary: Eliminar datos de paciente
      description: |
        Elimina todos los datos almacenados de una paciente.
        
        **Advertencia:** Esta acción es irreversible y está destinada principalmente para testing.
        
        Se eliminan:
        - Perfil de paciente
        - Historial de conversación
        - Medicación
        - Citas
        - Historial de síntomas
      operationId: deletePatient
      parameters:
        - name: phone
          in: path
          required: true
          description: Número de teléfono de la paciente
          schema:
            type: string
          example: "+56912345678"
      responses:
        '200':
          description: Datos eliminados correctamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  deleted_files:
                    type: array
                    items:
                      type: string
                    example:
                      - "/data/patients/56912345678.json"
                      - "/data/conversations/56912345678.json"
        '500':
          description: Error interno
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    MessageRequest:
      type: object
      required:
        - phone
        - message
      properties:
        phone:
          type: string
          description: Número de teléfono de la paciente (formato internacional)
          example: "+56912345678"
        message:
          type: string
          description: Contenido del mensaje
          example: "Hola, me siento cansada hoy"

    CheckinRequest:
      type: object
      required:
        - phone
      properties:
        phone:
          type: string
          description: Número de teléfono de la paciente
          example: "+56912345678"

    AgentResponse:
      type: object
      properties:
        reply_text:
          type: string
          description: Texto para enviar a la paciente por WhatsApp
          example: "Lamento escuchar que te sientes cansada..."
        actions:
          type: array
          items:
            type: string
            enum:
              - SEND_MESSAGE
              - OPEN_RISK_ALERT
              - UPDATE_SYMPTOM_TRACKING
              - SCHEDULE_MED_REMINDERS
              - SCHEDULE_APPOINTMENT_REMINDERS
          description: |
            Acciones que debe realizar el backend:
            - `SEND_MESSAGE`: Enviar reply_text por WhatsApp
            - `OPEN_RISK_ALERT`: Activar alerta de emergencia
            - `UPDATE_SYMPTOM_TRACKING`: Síntomas ya guardados automáticamente
            - `SCHEDULE_MED_REMINDERS`: Programar recordatorios de medicación
            - `SCHEDULE_APPOINTMENT_REMINDERS`: Programar recordatorios de citas
          example: ["SEND_MESSAGE", "UPDATE_SYMPTOM_TRACKING"]
        risk_level:
          type: string
          enum: [none, low, medium, high]
          description: |
            Nivel de riesgo clasificado:
            - `high` (80-100): Síntomas graves, recomendar urgencias
            - `medium` (40-79): Requiere atención próxima
            - `low` (10-39): Malestar leve
            - `none` (0-9): Sin síntomas relevantes
          example: "low"
        risk_score:
          type: integer
          minimum: 0
          maximum: 100
          description: Puntuación numérica del riesgo (0-100)
          example: 25
        symptom_summary:
          type: string
          description: Resumen de los síntomas reportados
          example: "Cansancio y dolor de cabeza leve"
        medication_schedule:
          type: array
          items:
            $ref: '#/components/schemas/MedicationItem'
          description: Medicamentos extraídos de recetas
        appointments:
          type: array
          items:
            $ref: '#/components/schemas/AppointmentItem'
          description: Acciones de citas médicas
        follow_up_questions:
          type: array
          items:
            type: string
          description: Preguntas de seguimiento sugeridas
          example: ["¿Has podido descansar lo suficiente?"]
        agent_used:
          type: string
          enum: [orchestrator, triage, medication, appointments, checkin, general]
          description: Agente que procesó el mensaje
          example: "checkin"

    MedicationItem:
      type: object
      properties:
        raw_text:
          type: string
          description: Texto original de la receta
          example: "Metformina 850mg, 1 tableta con el desayuno y 1 con la cena"
        medicine_name:
          type: string
          description: Nombre del medicamento
          example: "Metformina"
        frequency_text:
          type: string
          description: Frecuencia descrita
          example: "2 veces al día"
        times_of_day:
          type: array
          items:
            type: string
          description: Horarios de toma (formato HH:MM)
          example: ["08:00", "20:00"]
        duration_days:
          type: integer
          description: Duración en días
          example: 30

    AppointmentItem:
      type: object
      properties:
        action:
          type: string
          enum: [REMIND, CONFIRM, CANCEL_REQUEST, RESCHEDULE_REQUEST]
          description: Acción de la cita
          example: "REMIND"
        appointment_id:
          type: string
          description: ID de la cita (si existe)
          example: "abc12345"
        date:
          type: string
          format: date
          description: Fecha de la cita (YYYY-MM-DD)
          example: "2025-12-15"
        time:
          type: string
          description: Hora de la cita (HH:MM)
          example: "10:00"
        specialist_type:
          type: string
          description: Tipo de especialista
          example: "ginecología"
        notes:
          type: string
          description: Notas adicionales

    PatientContext:
      type: object
      properties:
        patient:
          type: object
          properties:
            name:
              type: string
              nullable: true
              example: null
            phone:
              type: string
              example: "+56912345678"
            profile:
              type: object
              properties:
                age:
                  type: integer
                  nullable: true
                medical_conditions:
                  type: array
                  items:
                    type: string
                allergies:
                  type: array
                  items:
                    type: string
                current_medications:
                  type: array
                  items:
                    type: string
                notes:
                  type: string
            current_risk_level:
              type: string
              enum: [none, low, medium, high]
            current_risk_score:
              type: integer
        active_medications:
          type: array
          items:
            type: object
        upcoming_appointments:
          type: array
          items:
            type: object
        recent_symptoms:
          type: array
          items:
            type: object
            properties:
              summary:
                type: string
              risk_level:
                type: string
              risk_score:
                type: integer
              timestamp:
                type: string
                format: date-time
        conversation_summary:
          type: string
          description: Resumen de la conversación reciente

    Error:
      type: object
      properties:
        error:
          type: string
          description: Mensaje de error
          example: "phone and message are required"

